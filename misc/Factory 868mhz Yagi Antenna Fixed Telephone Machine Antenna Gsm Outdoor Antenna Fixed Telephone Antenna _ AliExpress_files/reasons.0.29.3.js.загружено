!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).reasons={})}(this,(function(e){"use strict";const n=Math.pow(36,9),t=35*n-1;let r={handler:"/aer-reasons/",service:"",details:{pkg:"0.29.3"},payload:{}};let o=[];function i(e){const{payload:n}=r,t=Object.assign(Object.assign({},e),{ts:(new Date).toISOString(),payload:Object.assign(Object.assign({},n),e.payload)});o.push(t)}let a=0;function s(){if(!o.length)return;const{handler:e,service:n,details:t}=r,i={version:1,details:t,messages:o,messageIndex:a};if(a++,!i.messages.length)return;i.messages=function(e){const n=e.filter((({code:e})=>"PERF"===e));if(n.length<=1)return e;const t=n.reduce(((e,n)=>({perf:Object.assign(Object.assign({},e.perf),n.perf),payload:Object.assign(Object.assign({},e.payload),n.payload)})),{});return[...e.filter((({code:e})=>"PERF"!==e)),Object.assign({code:"PERF",message:""},t)]}(i.messages);const s=e+n,c=JSON.stringify(i);!/\sWindVane\//.test(window.navigator.userAgent)&&"undefined"!=typeof navigator&&navigator.sendBeacon?navigator.sendBeacon(s,c):fetch(s,{method:"POST",mode:"cors",body:c}).catch((e=>{console.error("Couldn't send a message to reason server",e)})),o=[]}const c=["gm.mmstat.com","ru.mmstat.com","ae.mmstat.com","log.mmstat.com","analytics.geo-stats.xyz","analyticsbyilnur.ru","tracksmall.com","track.onef.pro"],u=e=>"alicdn.com"===e.split(".").slice(-2).join("."),d=e=>u(e)?"alicdn":"st.aliexpress.ru"===e?"s3":c.some((n=>e===n))?"metric":"other";function f(e){if(!e||!window.PerformanceObserver)return;const n=[],t=[],r={};new PerformanceObserver((e=>{e.getEntriesByType("resource").forEach((({initiatorType:e,duration:o,name:i,encodedBodySize:a})=>{if("img"!==e)return;const s=new URL(i);r[s.hostname]?r[s.hostname]++:r[s.hostname]=1;if(!(({name:e})=>{const n=new URL(e);return"st.aliexpress.ru"===n.hostname||u(n.hostname)})({name:i}))return;const c=(e=>{if(!e)return null;let n="other",t="unknown";const r=new URL(e),o=u(r.hostname),i=r.pathname.split("."),a=i[i.length-1].toLowerCase();if(["gif","jpg","png","webp","jpeg","svg"].includes(a)?n=a:a||(n="unknown"),o){const e=new RegExp(/_(\d{2,3}x\d{2,3})/g),n=r.pathname.match(e);t=n?n[n.length-1].substring(1):"full"}return{format:n,size:t,host:d(r.hostname)}})(i);if(!c)return;const f=(l=o,(null===(m=[100,300,1e3,3e3,1e4,3e4].find((e=>e>=l)))||void 0===m?void 0:m.toString())||"Inf");var l,m;const p=(e=>{var n;return(null===(n=[3e3,1e4,3e4,1e5,3e5].find((n=>n>=e)))||void 0===n?void 0:n.toString())||"Inf"})(a),v=n.find((({format:e,size:n,bucket:t,host:r})=>e===c.format&&n===c.size&&t===f&&r===c.host)),g=t.find((({format:e,size:n,bodySize:t})=>e===c.format&&n===c.size&&t===p));v?v.count+=1:n.push({format:c.format,size:c.size,host:c.host,bucket:f,count:1}),g?g.count+=1:t.push({format:c.format,size:c.size,count:1,bodySize:p})}))})).observe({type:"resource",buffered:!0}),window.addEventListener("beforeunload",(()=>{i({code:"PERF",message:"",perf:{imgs_data:n,imgs_size_data:t,imgs_domain:r}})}))}var l,m,p,v,g,h=-1,y=function(e){addEventListener("pageshow",(function(n){n.persisted&&(h=n.timeStamp,e(n))}),!0)},w=function(){return window.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0]},E=function(){var e=w();return e&&e.activationStart||0},b=function(e,n){var t=w(),r="navigate";return h>=0?r="back-forward-cache":t&&(document.prerendering||E()>0?r="prerender":document.wasDiscarded?r="restore":t.type&&(r=t.type.replace(/_/g,"-"))),{name:e,value:void 0===n?-1:n,rating:"good",delta:0,entries:[],id:"v3-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:r}},T=function(e,n,t){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){var r=new PerformanceObserver((function(e){Promise.resolve().then((function(){n(e.getEntries())}))}));return r.observe(Object.assign({type:e,buffered:!0},t||{})),r}}catch(e){}},L=function(e,n,t,r){var o,i;return function(a){n.value>=0&&(a||r)&&((i=n.value-(o||0))||void 0===o)&&(o=n.value,n.delta=i,n.rating=function(e,n){return e>n[1]?"poor":e>n[0]?"needs-improvement":"good"}(n.value,t),e(n))}},S=function(e){requestAnimationFrame((function(){return requestAnimationFrame((function(){return e()}))}))},O=function(e){var n=function(n){"pagehide"!==n.type&&"hidden"!==document.visibilityState||e(n)};addEventListener("visibilitychange",n,!0),addEventListener("pagehide",n,!0)},j=function(e){var n=!1;return function(t){n||(e(t),n=!0)}},_=-1,C=function(){return"hidden"!==document.visibilityState||document.prerendering?1/0:0},P=function(e){"hidden"===document.visibilityState&&_>-1&&(_="visibilitychange"===e.type?e.timeStamp:0,I())},k=function(){addEventListener("visibilitychange",P,!0),addEventListener("prerenderingchange",P,!0)},I=function(){removeEventListener("visibilitychange",P,!0),removeEventListener("prerenderingchange",P,!0)},R=function(){return _<0&&(_=C(),k(),y((function(){setTimeout((function(){_=C(),k()}),0)}))),{get firstHiddenTime(){return _}}},A=function(e){document.prerendering?addEventListener("prerenderingchange",(function(){return e()}),!0):e()},M=[1800,3e3],x=function(e,n){n=n||{},A((function(){var t,r=R(),o=b("FCP"),i=T("paint",(function(e){e.forEach((function(e){"first-contentful-paint"===e.name&&(i.disconnect(),e.startTime<r.firstHiddenTime&&(o.value=Math.max(e.startTime-E(),0),o.entries.push(e),t(!0)))}))}));i&&(t=L(e,o,M,n.reportAllChanges),y((function(r){o=b("FCP"),t=L(e,o,M,n.reportAllChanges),S((function(){o.value=performance.now()-r.timeStamp,t(!0)}))})))}))},F=[.1,.25],z={passive:!0,capture:!0},D=new Date,B=function(e,n){l||(l=n,m=e,p=new Date,N(removeEventListener),U())},U=function(){if(m>=0&&m<p-D){var e={entryType:"first-input",name:l.type,target:l.target,cancelable:l.cancelable,startTime:l.timeStamp,processingStart:l.timeStamp+m};v.forEach((function(n){n(e)})),v=[]}},H=function(e){if(e.cancelable){var n=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,n){var t=function(){B(e,n),o()},r=function(){o()},o=function(){removeEventListener("pointerup",t,z),removeEventListener("pointercancel",r,z)};addEventListener("pointerup",t,z),addEventListener("pointercancel",r,z)}(n,e):B(n,e)}},N=function(e){["mousedown","keydown","touchstart","pointerdown"].forEach((function(n){return e(n,H,z)}))},$=[100,300],q=0,J=1/0,W=0,V=function(e){e.forEach((function(e){e.interactionId&&(J=Math.min(J,e.interactionId),W=Math.max(W,e.interactionId),q=W?(W-J)/7+1:0)}))},G=function(){return g?q:performance.interactionCount||0},K=function(){"interactionCount"in performance||g||(g=T("event",V,{type:"event",buffered:!0,durationThreshold:0}))},Q=[200,500],X=0,Y=function(){return G()-X},Z=[],ee={},ne=function(e){var n=Z[Z.length-1],t=ee[e.interactionId];if(t||Z.length<10||e.duration>n.latency){if(t)t.entries.push(e),t.latency=Math.max(t.latency,e.duration);else{var r={id:e.interactionId,latency:e.duration,entries:[e]};ee[r.id]=r,Z.push(r)}Z.sort((function(e,n){return n.latency-e.latency})),Z.splice(10).forEach((function(e){delete ee[e.id]}))}},te=[2500,4e3],re={},oe=[800,1800],ie=function e(n){document.prerendering?A((function(){return e(n)})):"complete"!==document.readyState?addEventListener("load",(function(){return e(n)}),!0):setTimeout(n,0)},ae=function(e,n){n=n||{};var t=b("TTFB"),r=L(e,t,oe,n.reportAllChanges);ie((function(){var o=w();if(o){var i=o.responseStart;if(i<=0||i>performance.now())return;t.value=Math.max(i-E(),0),t.entries=[o],r(!0),y((function(){t=b("TTFB",0),(r=L(e,t,oe,n.reportAllChanges))(!0)}))}}))};function se(e,n=0){return+`${Math.round(`${e}e+${n}`)}e-${n}`}const ce=(e,n,t=0)=>{e.value&&i({code:"PERF",message:"",perf:{[n]:se(e.value,t)}})};function ue(){!function(e,n){n=n||{},x(j((function(){var t,r=b("CLS",0),o=0,i=[],a=function(e){e.forEach((function(e){if(!e.hadRecentInput){var n=i[0],t=i[i.length-1];o&&e.startTime-t.startTime<1e3&&e.startTime-n.startTime<5e3?(o+=e.value,i.push(e)):(o=e.value,i=[e])}})),o>r.value&&(r.value=o,r.entries=i,t())},s=T("layout-shift",a);s&&(t=L(e,r,F,n.reportAllChanges),O((function(){a(s.takeRecords()),t(!0)})),y((function(){o=0,r=b("CLS",0),t=L(e,r,F,n.reportAllChanges),S((function(){return t()}))})),setTimeout(t,0))})))}((e=>ce(e,"cumulative_layout_shift",4))),function(e,n){n=n||{},A((function(){var t,r=R(),o=b("FID"),i=function(e){e.startTime<r.firstHiddenTime&&(o.value=e.processingStart-e.startTime,o.entries.push(e),t(!0))},a=function(e){e.forEach(i)},s=T("first-input",a);t=L(e,o,$,n.reportAllChanges),s&&O(j((function(){a(s.takeRecords()),s.disconnect()}))),s&&y((function(){var r;o=b("FID"),t=L(e,o,$,n.reportAllChanges),v=[],m=-1,l=null,N(addEventListener),r=i,v.push(r),U()}))}))}((e=>ce(e,"first_input_delay"))),function(e,n){n=n||{},A((function(){var t;K();var r,o=b("INP"),i=function(e){e.forEach((function(e){e.interactionId&&ne(e),"first-input"===e.entryType&&!Z.some((function(n){return n.entries.some((function(n){return e.duration===n.duration&&e.startTime===n.startTime}))}))&&ne(e)}));var n,t=(n=Math.min(Z.length-1,Math.floor(Y()/50)),Z[n]);t&&t.latency!==o.value&&(o.value=t.latency,o.entries=t.entries,r())},a=T("event",i,{durationThreshold:null!==(t=n.durationThreshold)&&void 0!==t?t:40});r=L(e,o,Q,n.reportAllChanges),a&&("interactionId"in PerformanceEventTiming.prototype&&a.observe({type:"first-input",buffered:!0}),O((function(){i(a.takeRecords()),o.value<0&&Y()>0&&(o.value=0,o.entries=[]),r(!0)})),y((function(){Z=[],X=G(),o=b("INP"),r=L(e,o,Q,n.reportAllChanges)})))}))}((e=>ce(e,"interaction_to_next_paint"))),function(e,n){n=n||{},A((function(){var t,r=R(),o=b("LCP"),i=function(e){var n=e[e.length-1];n&&n.startTime<r.firstHiddenTime&&(o.value=Math.max(n.startTime-E(),0),o.entries=[n],t())},a=T("largest-contentful-paint",i);if(a){t=L(e,o,te,n.reportAllChanges);var s=j((function(){re[o.id]||(i(a.takeRecords()),a.disconnect(),re[o.id]=!0,t(!0))}));["keydown","click"].forEach((function(e){addEventListener(e,(function(){return setTimeout(s,0)}),!0)})),O(s),y((function(r){o=b("LCP"),t=L(e,o,te,n.reportAllChanges),S((function(){o.value=performance.now()-r.timeStamp,re[o.id]=!0,t(!0)}))}))}}))}((e=>ce(e,"largest_contentful_paint"))),x((e=>ce(e,"first_contentful_paint"))),ae((e=>ce(e,"time_to_first_byte")))}let de,fe=!1;function le(e,n){if(fe!==!!e)if(fe=!!e,fe){if(Math.random()>=n)return;ue();const{getPerfObjects:e}=function(){let e={};return new PerformanceObserver((n=>{for(const t of n.getEntries()){const{name:n,duration:r}=t;e[n]=r}})).observe({type:"measure"}),{getPerfObjects:function(){const n=e;return e={},n}}}();de=function(){const n=function(){var e;const n=window.performance;if(!n)return null;const t=n.getEntriesByType("navigation")[0],r={},o={};if(t){const{requestStart:n,responseStart:i,responseEnd:a,domInteractive:s,domComplete:c,activationStart:u=0}=t;Object.assign(o,{requestStart:n,responseStart:i,responseEnd:a,domInteractive:s,domComplete:c,activationStart:u});const d=navigator;"undefined"!=typeof navigator&&Object.assign(o,{memory:d.deviceMemory,cpus:d.hardwareConcurrency,connection:null===(e=d.connection)||void 0===e?void 0:e.effectiveType}),a&&(r.download_time=se(a-u)),c&&(r.time_to_rendering=se(c-u)),s&&(r.time_to_dom_interactive=se(s-u))}return window.performance.getEntriesByType("paint").forEach((({name:e,startTime:n})=>{"first-paint"===e&&(r.first_paint=se(n))})),{code:"PERF",message:"",perf:r,payload:o}}();n&&(n.perf=Object.assign(n.perf||{},e()),i(n))},window.addEventListener("beforeunload",de)}else window.removeEventListener("beforeunload",de)}const me=(e,n)=>{const t=d(e);n[t]||(n[t]=0),n[t]+=1};function pe(e){const n=[];return Object.keys(e).forEach((t=>{n.push({host:t,count:e[t]})})),n}function ve(e){const{error:n,filename:t,lineno:r,colno:o,message:a}=e;i({message:`${(null==n?void 0:n.message)||n||a} at ${t}:${r}:${o}`,code:"UNHANDLED",stack:n?n.stack:void 0})}function ge(e){const{reason:n}=e;i({message:null==n?void 0:n.message,code:"UNHANDLED_PROMISE",stack:null==n?void 0:n.stack,payload:{reason:n?JSON.stringify(n):void 0}})}let he=!1;function ye(e){he!==!!e&&(he=!!e,he?(window.addEventListener("error",ve),window.addEventListener("unhandledrejection",ge)):(window.removeEventListener("error",ve),window.removeEventListener("unhandledrejection",ge)))}let we=0;function Ee(){setTimeout((()=>{we<30&&(we+=1,s(),Ee())}),12e4)}e.reasonsInit=function(e){const{trackClientPerf:o=!1,trackClientPerfRate:a=1,trackClientImgPerf:c=!0,trackImgError:u=!0,trackUnhandled:d=!0,service:l}=e;if(!l)throw new Error("Please provide service name for Reasons");!function(e){const{handler:o,service:i,details:a,payload:s}=e;r=Object.assign(Object.assign({},r),{handler:void 0!==o?o+(o.endsWith("/")?"":"/"):r.handler,service:i||r.service,details:Object.assign(Object.assign(Object.assign({},r.details),{url:window.location.href,reason_id:Math.floor(Math.random()*t+n).toString(36)}),a),payload:Object.assign(Object.assign({},r.payload),s)})}(e),ye(d),le(o,a),f(c),function(e){if(!e)return;let n=!1;const t=new Set,r=new Set;document.addEventListener("error",(({target:e})=>{e instanceof HTMLImageElement&&e.src&&t.add(e.src)}),!0),document.addEventListener("load",(({target:e})=>{e instanceof HTMLImageElement&&e.src&&r.add(e.src)}),!0),window.addEventListener("beforeunload",(()=>{if(n)return;n=!0;const e={},o={},a={},s=Array.from(document.querySelectorAll("img")),c=Array.from(t),u=Array.from(r);s.forEach((e=>{if(!e.src)return;const n=new URL(e.src);me(n.hostname,a)})),c.forEach((n=>{const t=new URL(n);me(t.hostname,e)})),u.forEach((e=>{const n=new URL(e);me(n.hostname,o)})),i({code:"PERF",message:"",perf:{imgs_errors:{total:pe(a),error:pe(e),loaded:pe(o)}},payload:{imgErrorSamplesList:c.slice(0,3)}})}))}(u),window.addEventListener("load",s),window.addEventListener("load",Ee),window.addEventListener("beforeunload",s)},e.sendReason=i,e.sendReasonList=function(e,n){const{payload:t}=r,i=e.map((e=>Object.assign(Object.assign({},e),{ts:(new Date).toISOString(),payload:Object.assign(Object.assign({},t),e.payload)})));o=[...o,...i],n&&s()},e.trackUnhandledErrors=ye}));
//# sourceMappingURL=reasons.0.29.3.js.map